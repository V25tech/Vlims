//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

namespace Vlims.Controllers
{
    using System;
    using System.Collections.Generic;
    using System.Data;
    using System.Text;
    using System.Xml.Serialization;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Extensions.Hosting;
    using Spire.Doc;
    using Spire.Doc.Documents;
    using Vlims.Common;
    using Vlims.DocumentManager.Manager;
    using Vlims.DocumentMaster.DataAccess;
    using Vlims.DocumentMaster.Entities;
    using Vlims.DocumentMaster.Manager;

    /// <summary>
    /// Comment
    /// </summary>
    [ApiController()]
    [Route("api/documenttemplateconfiguration")]
    public class DocumentTemplateConfigurationController : ControllerBase
    {

        private readonly IDocumentTemplateConfigurationService documentTemplateConfigurationService;

        private readonly string htmlUpper = "<html>\r\n<head>\r\n<style type=\"text/css\">\r\n        li, p, table {\r\n            font-family: 'Lucida Sans Unicode', sans-serif;\r\n            font-size: 14pt;\r\n        }\r\n\t\ttable {\r\n            font-family: 'Lucida Sans Unicode', sans-serif;\r\n            font-size: 14pt;\r\n            border: 1px solid black; /* Set border to 1px solid black */\r\n            width: 100%;\r\n        }\r\n</style>\r\n</head>\r\n<body>";
        private readonly string htmllower = "</body>\r\n</html>";

        /// <summary>
        /// 
        /// </summary>
        /// <param name="documentTemplateConfigurationService"></param>
        public DocumentTemplateConfigurationController(IDocumentTemplateConfigurationService documentTemplateConfigurationService)
        {
            this.documentTemplateConfigurationService = documentTemplateConfigurationService;
        }

        /// <summary>
        /// This method is used to Get List of DocumentTemplateConfiguration
        /// </summary>
        /// <param name="requestContext"></param>
        [HttpPost("getalldoctemplate")]
        public ActionResult GetAllDocumentTemplateConfiguration([FromQuery] RequestContext requestContext)
        {
            var result = documentTemplateConfigurationService.GetAllDocumentTemplateConfiguration(requestContext);
            return Ok(result);
        }

        /// <summary>
        /// This method is used to Get DocumentTemplateConfiguration By Id dTID
        /// </summary>
        /// <param name="dTID"></param>
        [HttpGet("getbyId")]
        public ActionResult<DocumentTemplateConfiguration> GetDocumentTemplateConfigurationByDTID(int dTID)
        {
            var result = documentTemplateConfigurationService.GetDocumentTemplateConfigurationByDTID(dTID);
            return result;
        }
        /// <summary>
        /// This method is used to Get DocumentTemplateConfiguration By Name
        /// </summary>
        /// <param name="name"></param>
        /// <returns></returns>
        [HttpGet("getbyName")]
        public ActionResult GetDocumentTemplateConfigurationByName(string name)
        {
            DocumentTemplateConfiguration responseContext = new DocumentTemplateConfiguration();
            RequestContext requestContext = new RequestContext();
            requestContext.PageNumber = 1;
            requestContext.PageSize = 50;
            var result = documentTemplateConfigurationService.GetAllDocumentTemplateConfiguration(requestContext);
            if (result != null)
            {
                responseContext = result.Response.FirstOrDefault(o => o.Templatename.Equals(name, StringComparison.InvariantCultureIgnoreCase));
            }
            return Ok(responseContext);
        }
        [HttpPost("upload-image")]
        public IActionResult UploadImage(IFormFile image)
        {
            try
            {
                if (image != null && image.Length > 0)
                {
                    var uploadsFolder = Path.Combine(Directory.GetCurrentDirectory(), "Logo");
                    var uniqueFileName = $"{Path.GetRandomFileName()}_{image.FileName}";

                    var filePath = Path.Combine(uploadsFolder, uniqueFileName);
                    using (var stream = new FileStream(filePath, FileMode.Create))
                    {
                        image.CopyTo(stream);
                    }

                    return Ok(new { Success = true, Message = uniqueFileName });
                }

                return BadRequest("Invalid image file");
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Internal server error: {ex.Message}");
            }
        }
        /// <summary>
        /// This Method is used to Save DocumentTemplateConfiguration
        /// </summary>
        /// <param name="documentTemplateConfiguration"></param>
        [HttpPost("savedocumenttemplateconfiguration")]
        public ActionResult<System.Boolean> SaveDocumentTemplateConfiguration(DocumentTemplateConfiguration documentTemplateConfiguration)
        {
            var result = documentTemplateConfigurationService.SaveDocumentTemplateConfiguration(documentTemplateConfiguration);
            return result;
        }

        /// <summary>
        /// This Method is used to update DocumentTemplateConfiguration
        /// </summary>
        /// <param name="documentTemplateConfiguration"></param>
        [HttpPost("updatedocumenttemplateconfiguration")]
        public ActionResult<System.Boolean> UpdateDocumentTemplateConfiguration(DocumentTemplateConfiguration documentTemplateConfiguration)
        {
            var result = documentTemplateConfigurationService.UpdateDocumentTemplateConfiguration(documentTemplateConfiguration);
            return result;
        }

        /// <summary>
        /// This Method is used to Delete DocumentTemplateConfiguration By Id dTID
        /// </summary>
        /// <param name="dTID"></param>
        [HttpDelete("{dTID}")]
        public ActionResult<bool> DeleteDocumentTemplateConfigurationByDTID(int dTID)
        {
            var result = documentTemplateConfigurationService.DeleteDocumentTemplateConfigurationByDTID(dTID);
            return result;
        }

        /// <summary>
        /// This Method is used to Delete DocumentTemplateConfiguration By Multiple ids dTIDs
        /// </summary>
        /// <param name="dTIDs"></param>
        [HttpDelete("deleteAll")]
        public ActionResult<bool> DeleteAllDocumentTemplateConfiguration(List<int> dTIDs)
        {
            var result = documentTemplateConfigurationService.DeleteAllDocumentTemplateConfiguration(dTIDs);
            return result;
        }
        [HttpGet("getpdf")]
        public  ActionResult<byte[]> getpdf(string templateinf)
        {
            byte[] bytes = null;
            DataSet dataset = DocumentTemplateConfigurationData.GetDocumentTemplateConfigurationByTemplate(templateinf);
            DataSet ds_template= DocumentTemplateConfigurationData.GetTemplateHeaderFooterDetails(templateinf);
            DocumentTemplateConfiguration template = DocumentTemplateConfigurationConverter.SetDocumentTemplateConfiguration(dataset);
            DocumentTemplateConfiguration template1 = DocumentTemplateConfigurationConverter.SetDocumentTemplateHeaderFooterConfiguration(ds_template);

            StringBuilder builder = new StringBuilder();
            builder.Append(htmlUpper);
            Document document = new Spire.Doc.Document();
            Section section = document.AddSection();
            section.PageSetup.Margins.All = 72f;
            HeaderFooter header = section.HeadersFooters.Header;
            Paragraph headerParagraph = header.AddParagraph();
            StringBuilder headerbuilder = new StringBuilder();
            headerbuilder.Append(htmlUpper);
            headerbuilder.Append(PrepareHeaderStaticdiv(template,template1));
            headerbuilder.Append(htmllower);
            headerParagraph.AppendHTML(headerbuilder.ToString());
            headerParagraph.Format.BeforeSpacing = 0;
            headerParagraph.Format.AfterSpacing = 0;
            headerParagraph.Format.PageBreakBefore = false;

            //section.PageSetup.Margins.Top = 0f;

            //section.PageSetup.Margins.Bottom = 0f;


            HeaderFooter footer = section.HeadersFooters.Footer;
            Paragraph footerParagraph = footer.AddParagraph();
            StringBuilder footerbuilder = new StringBuilder();
            footerbuilder.Append(htmlUpper);
            footerbuilder.Append(PrepareStaticdiv(template,template1));
            footerbuilder.Append(htmllower);
            footerParagraph.AppendHTML(footerbuilder.ToString());
            footerParagraph.Format.BeforeSpacing = 0;
            footerParagraph.Format.AfterSpacing = 0;
            footerParagraph.Format.PageBreakBefore = false;

            Paragraph paragraph = section.AddParagraph();

            for (int i = 0; i < template.Pages; i++)
            {
                builder.Append(htmlUpper);
                builder.Append(template.Page[i].text);
                builder.Append(htmllower);
                builder.Append("<div style=\"page-break-before: always;\"></div>");
            }
            paragraph.Format.BeforeSpacing = -10;

            paragraph.Format.AfterSpacing = 0;
            paragraph.AppendHTML(builder.ToString());
            document.SaveToFile("DocumentWithMargins.docx", FileFormat.Docx2013);
            document.Dispose();


            Document doc = new Document();
            doc.LoadFromFile("DocumentWithMargins.docx");
            string pathhh = Path.Combine(Directory.GetCurrentDirectory(), "DocumentWithMargins.docx");
            byte[] pdfBytes1= System.IO.File.ReadAllBytes(pathhh);
            string pdfFilePath = "DocumentWithHeaderTable.pdf";
            doc.SaveToFile(pdfFilePath, FileFormat.PDF);
            byte[] pdfBytes = ConvertDocxToPdfBytes(doc);
            doc.Dispose();
            bytes = pdfBytes;
            return bytes;

        }


        static byte[] ConvertDocxToPdfBytes(Document document)

        {

            using (MemoryStream stream = new MemoryStream())

            {

                document.SaveToStream(stream, FileFormat.PDF);

                return stream.ToArray();

            }

        }

        public static string PrepareStaticdiv(DocumentTemplateConfiguration template, DocumentTemplateConfiguration template1)
        {
            string table = string.Empty;
            StringBuilder htmlBuilder = new StringBuilder();
            //htmlBuilder.Append("<style>");
            //htmlBuilder.Append(".table-container { display: table; width: 100%; border-collapse: collapse; }");
            //htmlBuilder.Append(".table-row { display: table-row; }");
            //htmlBuilder.Append(".table-cell { display: table-cell; padding: 1px;}");
            //htmlBuilder.Append(".label-cell { text-align: left; font-weight: bold; width: 50px; }");
            //htmlBuilder.Append(".value-cell { text-align: center; width: 50px; }");
            //htmlBuilder.Append("</style>");
            //htmlBuilder.Append("<div class=\"table-container\">");

            // Append the style information
            htmlBuilder.AppendLine("<style type=\"text/css\">");
            htmlBuilder.AppendLine(".tg  {border-collapse:collapse;border-spacing:0;}");
            htmlBuilder.AppendLine(".tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}");
            htmlBuilder.AppendLine(".tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}");
            htmlBuilder.AppendLine(".tg .tg-0p91{border-color:inherit;font-family:\"Times New Roman\", Times, serif !important;text-align:center;vertical-align:top}");
            htmlBuilder.AppendLine(".tg .tg-53v8{border-color:inherit;font-family:\"Times New Roman\", Times, serif !important;font-weight:bold;text-align:left;vertical-align:top}");
            htmlBuilder.AppendLine(".tg .tg-iucd{border-color:inherit;font-family:\"Times New Roman\", Times, serif !important;text-align:left;vertical-align:top}");
            htmlBuilder.AppendLine("</style>");

            htmlBuilder.AppendLine("<table class=\"tg\">");
            htmlBuilder.AppendLine("<thead>");
            htmlBuilder.AppendLine("  <tr>");
            htmlBuilder.AppendLine("    <th class=\"tg-zd42\"></th>");
            htmlBuilder.AppendLine("    <th class=\"tg-adin\">Prepared By</th>");
            htmlBuilder.AppendLine("    <th class=\"tg-adin\">Checked By</th>");
            htmlBuilder.AppendLine("    <th class=\"tg-adin\">Approved By</th>");
            htmlBuilder.AppendLine("  </tr>");
            htmlBuilder.AppendLine("</thead>");
            htmlBuilder.AppendLine("<tbody>");
            htmlBuilder.AppendLine("  <tr>");
            htmlBuilder.AppendLine("    <th class=\"tg-adin\">Signature</th>");
            htmlBuilder.AppendLine("    <td class=\"tg-zd42\"></td>");
            htmlBuilder.AppendLine("    <td class=\"tg-zd42\"></td>");
            htmlBuilder.AppendLine("    <td class=\"tg-zd42\"></td>");
            htmlBuilder.AppendLine("  </tr>");
            htmlBuilder.AppendLine("  <tr>");
            htmlBuilder.AppendLine("    <th class=\"tg-adin\">Date</th>");
            htmlBuilder.AppendLine("    <td class=\"tg-zd42\"></td>");
            htmlBuilder.AppendLine("    <td class=\"tg-zd42\"></td>");
            htmlBuilder.AppendLine("    <td class=\"tg-zd42\"></td>");
            htmlBuilder.AppendLine("  </tr>");
            htmlBuilder.AppendLine("  <tr>");
            htmlBuilder.AppendLine("    <th class=\"tg-adin\">Name</th>");
            htmlBuilder.AppendLine($"    <td class=\"tg-zd42\">{template1.PreparedBy}</td>");
            htmlBuilder.AppendLine($"    <td class=\"tg-zd42\">{template1.ReviewedBy}</td>");
            htmlBuilder.AppendLine($"    <td class=\"tg-zd42\">{template1.ApprovedBy}</td>");
            htmlBuilder.AppendLine("  </tr>");
            htmlBuilder.AppendLine("  <tr>");
            htmlBuilder.AppendLine("    <th class=\"tg-adin\">Designation</th>");
            htmlBuilder.AppendLine($"    <td class=\"tg-zd42\">{template1.PreparedRole}</td>");
            htmlBuilder.AppendLine($"    <td class=\"tg-zd42\">{template1.ReviewedRole}</td>");
            htmlBuilder.AppendLine($"    <td class=\"tg-zd42\">{template1.ApprovedRole}</td>");
            htmlBuilder.AppendLine("  </tr>");
            htmlBuilder.AppendLine("  <tr>");
            htmlBuilder.AppendLine("    <th class=\"tg-adin\">Department</th>");
            htmlBuilder.AppendLine($"    <td class=\"tg-zd42\">{template1.PrepareDept}</td>");
            htmlBuilder.AppendLine($"    <td class=\"tg-zd42\">{template1.ReviewedDept}</td>");
            htmlBuilder.AppendLine($"    <td class=\"tg-zd42\">{template1.ApprovedDept}</td>");
            htmlBuilder.AppendLine("  </tr>");
            htmlBuilder.AppendLine("</tbody>");
            htmlBuilder.AppendLine("</table>");
            table = htmlBuilder.ToString();
            return table;

        }

        public static string PrepareHeaderStaticdiv(DocumentTemplateConfiguration template, DocumentTemplateConfiguration template1)
        {
            string table = string.Empty;
            StringBuilder htmlBuilder = new StringBuilder();

            //DocumentPreparationService prepservice = new DocumentPreparationService();
            //DocumentEffectiveService effectiveService= new DocumentEffectiveService();
            //AdditionalTaskService taskService = new AdditionalTaskService();
            //DocumentrequestService documentrequestService = new DocumentrequestService();

            //RequestContext context = new RequestContext();
            //context.PageNumber = 1; context.PageSize = 1000;
            //var prep=prepservice.GetAllDocumentPreparation(context).Response.Where(o=>o.template.Equals(template.Templatename,StringComparison.InvariantCultureIgnoreCase));
            //var reqList = documentrequestService.GetAllDocumentrequest(context).Response.Where(o => o..Equals(template.Templatename, StringComparison.InvariantCultureIgnoreCase)); ;
            //var effList = effectiveService.GetAllDocumentEffective(context);
            //var revisionList = taskService.GetAllAdditionalTask(context);

            // Read the contents of the SVG file
            string currentDirectory = Directory.GetCurrentDirectory();
            string path = Path.Combine(currentDirectory,"Logo", template.header);
            string base64EncodedImage = Convert.ToBase64String(System.IO.File.ReadAllBytes(path));
            string dataUri = $"data:image/jpeg;base64,{base64EncodedImage}";
            // Append the style information
            htmlBuilder.AppendLine("<style type=\"text/css\">");
            htmlBuilder.AppendLine(".tg  {border-collapse:collapse;border-spacing:0;}");
            htmlBuilder.AppendLine(".tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}");
            htmlBuilder.AppendLine(".tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}");
            htmlBuilder.AppendLine(".tg .tg-0p91{border-color:inherit;font-family:\"Times New Roman\", Times, serif !important;text-align:center;vertical-align:top}");
            htmlBuilder.AppendLine(".tg .tg-53v8{border-color:inherit;font-family:\"Times New Roman\", Times, serif !important;font-weight:bold;text-align:left;vertical-align:top}");
            htmlBuilder.AppendLine(".tg .tg-iucd{border-color:inherit;font-family:\"Times New Roman\", Times, serif !important;text-align:left;vertical-align:top}");
            htmlBuilder.AppendLine("</style>");

            // Append the table
            htmlBuilder.AppendLine("<table class=\"tg\">");
            htmlBuilder.AppendLine("<thead>");
            htmlBuilder.AppendLine("  <tr>");
            htmlBuilder.AppendLine($@"<th class=""tg-iucd""><img src=""{dataUri}"" width=""80"" height=""80"" /></th>");
            //htmlBuilder.AppendLine($@"<th class=""tg-iucd""><img src=""{dataUri}"" width=""20"" height=""20"" /></th>");
            //htmlBuilder.AppendLine($@"<img src=""{dataUri}"" width=""20"" height=""20"" />");
            htmlBuilder.AppendLine($"    <th class=\"tg-0p91\" colspan=\"2\">{template.titleTable[0][0].inputValue}</th>");
            htmlBuilder.AppendLine("    <th class=\"tg-iucd\"></th>");
            htmlBuilder.AppendLine("  </tr>");
            htmlBuilder.AppendLine("</thead>");
            htmlBuilder.AppendLine("<tbody>");
            htmlBuilder.AppendLine("  <tr>");
            //htmlBuilder.AppendLine("    <td class=\"tg-iucd\" colspan=\"2\">Title: Preparation, checking, approval, control, distribution, <br>revision, retrieval &amp; destruction of standard operating procedure</td>");
            //htmlBuilder.AppendLine($"   <td class=\"ttg-iucd\" colspan=\"t2\"t><span style=\"tfont-weight:bold\"t>Title:</span> {template1.DocumentTitle}</td>");
            htmlBuilder.AppendLine($"    <td class=\"tg-iucd\" colspan=\"2\"><span style=\"font-weight:bold\">Title:</span> {template1.DocumentTitle}</td>");
            htmlBuilder.AppendLine("    <td class=\"tg-53v8\">SOP No.</td>");
            htmlBuilder.AppendLine($"    <td class=\"tg-iucd\">{template1.DocumentNo}</td>");
            htmlBuilder.AppendLine("  </tr>");
            htmlBuilder.AppendLine("  <tr>");
            htmlBuilder.AppendLine("    <td class=\"tg-53v8\">Revision No.</td>");
            htmlBuilder.AppendLine($"    <td class=\"tg-iucd\">{template1.Version}</td>");
            htmlBuilder.AppendLine("    <td class=\"tg-53v8\">Supersedes</td>");
            htmlBuilder.AppendLine($"    <td class=\"tg-iucd\">{template1.Supersedes}</td>");
            htmlBuilder.AppendLine("  </tr>");
            htmlBuilder.AppendLine("  <tr>");
            htmlBuilder.AppendLine("    <td class=\"tg-53v8\">Depaertment</td>");
            htmlBuilder.AppendLine($"    <td class=\"tg-iucd\">{template1.Department}</td>");
            htmlBuilder.AppendLine("    <td class=\"tg-53v8\">Page No.</td>");
            htmlBuilder.AppendLine("    <td class=\"tg-iucd\">1 of 29</td>");
            htmlBuilder.AppendLine("  </tr>");
            htmlBuilder.AppendLine("  <tr>");
            htmlBuilder.AppendLine("    <td class=\"tg-53v8\">Effective Date</td>");
            htmlBuilder.AppendLine($"    <td class=\"tg-iucd\">{template1.EffectiveDate}</td>");
            htmlBuilder.AppendLine("    <td class=\"tg-53v8\">Review Date</td>");
            htmlBuilder.AppendLine($"    <td class=\"tg-iucd\">{template1.ReviewDate}</td>");
            htmlBuilder.AppendLine("  </tr>");
            htmlBuilder.AppendLine("</tbody>");
            htmlBuilder.AppendLine("</table>");
            table = htmlBuilder.ToString();
            return table;

        }
        public static string PrepareHeaderdiv(DocumentTemplateConfiguration Template)
        {
            string table = string.Empty;
            StringBuilder tableHtml = new StringBuilder();
            // Add CSS styles
            tableHtml.Append("<style>");
            tableHtml.Append(".table-container { display: table; width: 100%; border-collapse: collapse; }");
            tableHtml.Append(".table-row { display: table-row; }");
            tableHtml.Append(".table-cell { display: table-cell; padding: 1px;}");
            tableHtml.Append(".label-cell { text-align: left; font-weight: bold; width: 50px; }");
            tableHtml.Append(".value-cell { text-align: center; width: 50px; }");
            tableHtml.Append("</style>");
            tableHtml.Append("<div class=\"table-container\">");

            foreach (List<HeaderTable> row in Template.headerTable)
            {
                tableHtml.Append("<div class=\"table-row\">");

                foreach (HeaderTable item in row)
                {
                    tableHtml.Append("<div class=\"table-cell ");

                    if (item.selectedOption == 1)
                    {
                        tableHtml.Append("label-cell");
                    }
                    else
                    {
                        tableHtml.Append("value-cell");
                    }

                    tableHtml.Append("\">");
                    if (item.selectedOption == 1)
                    {

                        tableHtml.Append(item.inputValue);
                    }
                    else
                        tableHtml.Append(item.inputValue);
                    tableHtml.Append("</div>");
                }

                tableHtml.Append("</div>");

            }
            tableHtml.Append("</div>");
            table = tableHtml.ToString();
            return table;

        }

        public static string PrepareFooterdiv(DocumentTemplateConfiguration Template)
        {
            string table = string.Empty;
            StringBuilder tableHtml = new StringBuilder();
            // Add CSS styles
            tableHtml.Append("<style>");
            tableHtml.Append(".table-container { display: table; width: 100%; border-collapse: collapse; }");
            tableHtml.Append(".table-row { display: table-row; }");
            tableHtml.Append(".table-cell { display: table-cell; padding: 1px;}");
            tableHtml.Append(".label-cell { text-align: left; font-weight: bold; width: 50px; }");
            tableHtml.Append(".value-cell { text-align: center; width: 50px; }");
            tableHtml.Append("</style>");
            tableHtml.Append("<div class=\"table-container\">");

            foreach (List<FooterTable> row in Template.footerTable)
            {
                tableHtml.Append("<div class=\"table-row\">");

                foreach (FooterTable item in row)
                {


                    tableHtml.Append("<div class=\"table-cell ");

                    if (item.selectedOption == 1)
                    {
                        tableHtml.Append("label-cell");
                    }
                    else
                    {
                        tableHtml.Append("value-cell");
                    }

                    tableHtml.Append("\">");
                    if (item.selectedOption == 1)
                    {
                        //if (!string.IsNullOrEmpty(item.inputValue))
                        //    tableHtml.Append(item.inputValue + " " + ":");
                        //else
                        tableHtml.Append(item.inputValue);
                    }
                    else
                        tableHtml.Append(item.inputValue);
                    tableHtml.Append("</div>");

                    //IsLabel = !IsLabel; // Toggle between label and value for each cell
                }

                tableHtml.Append("</div>");

            }
            tableHtml.Append("</div>");
            table = tableHtml.ToString();
            return table;

        }
    }
}
